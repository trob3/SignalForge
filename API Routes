from fastapi import APIRouter, File, UploadFile, HTTPException
import pandas as pd

from signalforge.core.normalization import normalize_alerts_df
from signalforge.core.scoring import score_detections

router = APIRouter(prefix="/v1")

@router.post("/score/csv")
async def score_csv(file: UploadFile = File(...)):
    if not file.filename.lower().endswith(".csv"):
        raise HTTPException(status_code=400, detail="Please upload a CSV file.")

    raw = await file.read()
    try:
        df = pd.read_csv(pd.io.common.BytesIO(raw))
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Could not parse CSV: {e}")

    norm = normalize_alerts_df(df)
    result = score_detections(norm)

    return result
